name: Meroshare IPO Automation

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 6 * * *"  # Runs daily at 6:00 AM UTC (11:45 AM NPT)
  workflow_dispatch:  # Allows manual runs from GitHub Actions tab
    inputs:
      member_index:
        description: 'Run for specific member (0-3) or leave empty for all'
        required: false
        type: string

jobs:
  cypress-run:
    runs-on: ubuntu-22.04
    timeout-minutes: 20  # Prevent workflow from running too long
    strategy:
      matrix:
        member_index: [0, 1, 2, 3]  # Index for each of the 4 members
      fail-fast: false  # Continue running other members even if one fails

    steps:
      # Step 1: Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # Step 2: Setup environment from shared secrets and member-specific info
      - name: Setup environment for Member ${{ matrix.member_index }}
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          KITTA: ${{ secrets.KITTA }}
          MAX_IPO_PRICE: ${{ secrets.MAX_IPO_PRICE }}
          MEMBERS_INFO: ${{ secrets.MEMBERS_INFO }}
        run: |
          # Create .env file with shared configuration
          echo "TELEGRAM_TOKEN=\"$TELEGRAM_TOKEN\"" > .env
          echo "TELEGRAM_CHAT_ID=\"$TELEGRAM_CHAT_ID\"" >> .env
          echo "KITTA=$KITTA" >> .env
          echo "MAX_IPO_PRICE=$MAX_IPO_PRICE" >> .env

          # Extract only the specific member from MEMBERS_INFO for this job
          SINGLE_MEMBER=$(echo "$MEMBERS_INFO" | jq -c "[.[${{ matrix.member_index }}]]")
          echo "MEMBERS_INFO='$SINGLE_MEMBER'" >> .env

          # Extract member name for display
          MEMBER_NAME=$(echo "$MEMBERS_INFO" | jq -r ".[${{ matrix.member_index }}].name")
          echo "MEMBER_NAME=$MEMBER_NAME" >> $GITHUB_ENV

          echo "Environment configured for $MEMBER_NAME"

      # Step 3: Run Cypress
      - name: Cypress run for ${{ env.MEMBER_NAME }}
        id: cypress
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
        continue-on-error: true

      # Step 3.5: Send authentication status notification
      - name: Check Authentication Status
        if: always()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Check Cypress results for authentication failure
          if [ "${{ steps.cypress.outcome }}" == "failure" ]; then
            # Check if it's an authentication error
            if grep -q "login" cypress/videos/* 2>/dev/null || [ ! -f "cypress/videos/meroshare.cy.js.mp4" ]; then
              MESSAGE="üîê Authentication Failed for ${{ env.MEMBER_NAME }} - Please check credentials"
              curl -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
                  -H "Content-Type: application/json" \
                  -d "{\"chat_id\": \"$TELEGRAM_CHAT_ID\", \"text\": \"$MESSAGE\"}"
            fi
          else
            MESSAGE="üîì Authentication Success for ${{ env.MEMBER_NAME }}"
            curl -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
                -H "Content-Type: application/json" \
                -d "{\"chat_id\": \"$TELEGRAM_CHAT_ID\", \"text\": \"$MESSAGE\"}"
          fi

      # Step 4: Upload artifacts (videos)
      - name: Upload Cypress videos for ${{ env.MEMBER_NAME }}
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos-${{ env.MEMBER_NAME }}
          path: cypress/videos
          retention-days: 30

      # Step 5: Notify Telegram about IPO Application
      - name: Notify IPO Application Status
        if: always()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Check if result file exists
          RESULT_FILE="cypress/results/${{ env.MEMBER_NAME }}-result.json"
          
          if [ -f "$RESULT_FILE" ]; then
            # Read the result
            STATUS=$(jq -r '.status' "$RESULT_FILE")
            TOTAL_IPOS=$(jq -r '.totalIPOs' "$RESULT_FILE")
            ELIGIBLE_IPOS=$(jq -r '.eligibleIPOs' "$RESULT_FILE")
            
            case "$STATUS" in
              "applied")
                COMPANY=$(jq -r '.appliedIPOs[0].company' "$RESULT_FILE")
                SCRIP=$(jq -r '.appliedIPOs[0].scrip' "$RESULT_FILE")
                MESSAGE="‚úÖ IPO Applied for ${{ env.MEMBER_NAME }}
          
          üìä Share: $COMPANY ($SCRIP)
          ‚ú® Status: Successfully Applied"
                ;;
              "already_applied")
                COMPANY=$(jq -r '.appliedIPOs[0].company' "$RESULT_FILE")
                SCRIP=$(jq -r '.appliedIPOs[0].scrip' "$RESULT_FILE")
                MESSAGE="‚ÑπÔ∏è Already Applied - ${{ env.MEMBER_NAME }}
          
          üìä Share: $COMPANY ($SCRIP)
          ‚è≠Ô∏è Skipping (already applied)"
                ;;
              "not_eligible")
                MESSAGE="‚ö†Ô∏è No Action Taken - ${{ env.MEMBER_NAME }}
          
          üìä Total IPOs Found: $TOTAL_IPOS
          ‚ùå Eligible: None (did not meet our criteria)"
                ;;
              "no_ipos")
                MESSAGE="üì≠ No IPO Available Today - ${{ env.MEMBER_NAME }}
          
          No shares available to apply for today."
                ;;
              "failed")
                COMPANY=$(jq -r '.appliedIPOs[0].company' "$RESULT_FILE")
                ERROR_MSG=$(jq -r '.appliedIPOs[0].message' "$RESULT_FILE")
                MESSAGE="‚ùå Application Failed - ${{ env.MEMBER_NAME }}
          
          üìä Share: $COMPANY
          ‚ö†Ô∏è Error: $ERROR_MSG"
                ;;
              *)
                MESSAGE="‚è≥ Pending - ${{ env.MEMBER_NAME }}"
                ;;
            esac
          else
            MESSAGE="‚ùå Error: No result file found for ${{ env.MEMBER_NAME }}"
          fi
          
          curl -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"$TELEGRAM_CHAT_ID\", \"text\": \"$MESSAGE\"}"
