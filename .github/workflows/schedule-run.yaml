name: Meroshare IPO Automation

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 6 * * *"  # Runs daily at 6:00 AM UTC (11:45 AM NPT)
  workflow_dispatch:  # Allows manual runs from GitHub Actions tab
    inputs:
      member_index:
        description: 'Run for specific member (0-3) or leave empty for all'
        required: false
        type: string

jobs:
  cypress-run:
    runs-on: ubuntu-22.04
    timeout-minutes: 20  # Prevent workflow from running too long
    strategy:
      matrix:
        member_index: [0, 1, 2, 3]  # Index for each of the 4 members
      fail-fast: false  # Continue running other members even if one fails

    steps:
      # Step 1: Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # Step 2: Setup environment from shared secrets and member-specific info
      - name: Setup environment for Member ${{ matrix.member_index }}
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          KITTA: ${{ secrets.KITTA }}
          MAX_IPO_PRICE: ${{ secrets.MAX_IPO_PRICE }}
          MEMBERS_INFO: ${{ secrets.MEMBERS_INFO }}
        run: |
          # Create .env file with shared configuration
          echo "TELEGRAM_TOKEN=\"$TELEGRAM_TOKEN\"" > .env
          echo "TELEGRAM_CHAT_ID=\"$TELEGRAM_CHAT_ID\"" >> .env
          echo "KITTA=$KITTA" >> .env
          echo "MAX_IPO_PRICE=$MAX_IPO_PRICE" >> .env
          
          # Extract member-specific info from MEMBERS_INFO JSON array
          MEMBER_DATA=$(echo "$MEMBERS_INFO" | jq -r ".[${{ matrix.member_index }}]")
          
          # Add member-specific configuration to .env
          echo "USER_NAME=\"$(echo "$MEMBER_DATA" | jq -r '.USER_NAME')\"" >> .env
          echo "PASSWORD=\"$(echo "$MEMBER_DATA" | jq -r '.PASSWORD')\"" >> .env
          echo "DP=\"$(echo "$MEMBER_DATA" | jq -r '.DP')\"" >> .env
          echo "TRANSACTION_PIN=$(echo "$MEMBER_DATA" | jq -r '.TRANSACTION_PIN')" >> .env
          echo "CRN=\"$(echo "$MEMBER_DATA" | jq -r '.CRN')\"" >> .env
          echo "BANK_NAME=\"$(echo "$MEMBER_DATA" | jq -r '.BANK_NAME')\"" >> .env
          
          # Extract member name for display
          MEMBER_NAME=$(echo "$MEMBER_DATA" | jq -r '.name')
          echo "MEMBER_NAME=$MEMBER_NAME" >> $GITHUB_ENV
          
          echo "Environment configured for $MEMBER_NAME"

      # Step 3: Run Cypress
      - name: Cypress run for ${{ env.MEMBER_NAME }}
        uses: cypress-io/github-action@v6
        with:
          browser: chrome

      # Step 4: Upload artifacts (videos)
      - name: Upload Cypress videos for ${{ env.MEMBER_NAME }}
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos-${{ env.MEMBER_NAME }}
          path: cypress/videos
          retention-days: 30

      # Step 5: Notify Telegram
      - name: Notify Telegram
        if: failure() || (success() && hashFiles('cypress/videos/**') != '')
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="Success"
          EMOJI="✅"
          if [ "${{ job.status }}" != "success" ]; then
            STATUS="Failed"
            EMOJI="❌"
          fi
          
          # Check if IPO application was made
          VIDEOS=$(find cypress/videos -type f 2>/dev/null || true)
          
          if [ -n "$VIDEOS" ]; then
            MESSAGE="$EMOJI IPO Application: $STATUS for ${{ env.MEMBER_NAME }}"
          else
            # Only notify on failure if no videos (means test failed before reaching IPO application)
            if [ "${{ job.status }}" != "success" ]; then
              MESSAGE="❌ Error occurred for ${{ env.MEMBER_NAME }}"
            else
              echo "No IPO applications made, skipping notification."
              exit 0
            fi
          fi
          
          curl -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"$TELEGRAM_CHAT_ID\", \"text\": \"$MESSAGE\"}"
